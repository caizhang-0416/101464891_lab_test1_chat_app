<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        .message {
            background-color: #f1f1f1;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            max-width: 80%;
        }

        .message-end {
            background-color: #AFDC8F;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            text-align: right;
            max-width: 80%;
            margin-left: auto;
        }

        .list-group-item {
            border: none;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="row" style="background-color: #f1f1f1; border-radius: 4px; padding: 8px;">
        <h2 class="col">Chat App</h2>
        <div class="col">
            <div class="text-end text">
            <button id="leaveRoom" class="btn btn-danger">Leave Room</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <h4 id="roomName"></h4>
            <h5>members: </h5>
            <ul id="userList" class="list-group">
                <!-- User list will be displayed here -->
            </ul>
        </div>
        <div class="col-md-8">
            <div id="chatBox" class="border p-3 mb-3" style="height: 300px; overflow-y: scroll;">
                <!-- Chat messages will be displayed here -->
            </div>
            <div id="typing" class="text-end"></div>
        </div>
    </div>
    <div class="row">
        <form id="chatForm">
            <div class="input-group">
                <input type="text" id="message" class="form-control" placeholder="Type a message" required>
                <button type="submit" class="btn btn-primary">Send</button>
            </div>
        </form>
    </div>
</div>

<script>
    const room = localStorage.getItem("room");
    if (!room) {
        window.location.href = "/room-list.html";
    }
    const currentUser = localStorage.getItem("username");
    if (!currentUser) {
        window.location.href = "/login.html";
    }

    const socket = io();
    document.getElementById("roomName").textContent = `Room Name: ${room}`;

    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const messageInput = document.getElementById("message");

    chatForm.onsubmit = (e) => {
        e.preventDefault();
        const message = messageInput.value;
        socket.emit("chatMessage", { room, username: currentUser, message });
        messageInput.value = "";
    };

    document.getElementById("leaveRoom").onclick = () => {
        socket.emit("leaveRoom", {room, username: currentUser});
        localStorage.removeItem("room");
        window.location.href = "/room-list.html";
    };

    socket.emit("joinRoom", { room, username: currentUser });

    socket.on("message", ({message, username, date_sent}) => {
        let messageElement;
        if (username !== currentUser) {
            messageElement = `<div class="message"><div><strong>${username}</strong> [${new Date(date_sent).toLocaleTimeString()}]:</div>`
                +`<div>${message}</div></div>`;
        } else {
            messageElement = `<div class="message-end"><div class="text-end"><strong>${username}</strong> [${new Date(date_sent).toLocaleTimeString()}]:</div>`
                +`<div class="text-end">${message}</div></div>`;
        }
        console.log(messageElement);
        chatBox.innerHTML += messageElement;
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("roomUsers", ({ users }) => {
        const userList = document.getElementById("userList");
        userList.innerHTML = "";
        users.forEach(username => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent =username;
            userList.appendChild(li);
        });
    });

    document.getElementById("message").addEventListener("input", function() {
        socket.emit("typing", {room, username: currentUser});
    });

    socket.on("typing", ({username}) => {
        if (username === currentUser) {
            return;
        }
        document.getElementById("typing").textContent = `${username} is typing...`;
        setTimeout(() => {
            document.getElementById("typing").textContent = "";
        }, 2000);
    });
</script>
</body>
</html>